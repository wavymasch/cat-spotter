<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat Spotter ‚Äî Kernel Heatmap Only</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 0; }
    .control {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: #ffffffee; backdrop-filter: blur(6px);
      padding: 12px; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.15);
      display: grid; gap: 8px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .control h1 { font-size: 16px; margin: 0 0 6px; }
    .control .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button {
      border: 0; border-radius: 10px; padding: 8px 10px; cursor: pointer;
      background: #111; color: #fff; font-weight: 600;
    }
    button.secondary { background: #f2f2f2; color: #111; }
    button.toggled { outline: 2px solid #111; }
    .notice { font-size: 12px; color: #444; }
    .count { font-weight: 700; }
  </style>
</head>
<body>
  <div id="map" aria-label="Map of cat sightings (heat only)"></div>

  <div class="control" role="region" aria-label="Controls">
    <h1>üêæ Cat Spotter</h1>
    <div class="row">
      <button id="addBtn" title="Click, then tap the map to add a sighting">Add sighting</button>
      <button id="stopBtn" class="secondary" title="Stop placing points">Stop adding</button>
    </div>
    <div class="row notice">
      <span>Total sightings: <span id="count" class="count">0</span></span>
      <span id="status" aria-live="polite"></span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Map setup ---
    const map = L.map('map').setView([47.3769, 8.5417], 12); // Z√ºrich default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Supabase config ---
    const SUPABASE_URL = 'https://diinrjgkyouofzbeqtyu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpaW5yamdreW91b2Z6YmVxdHl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODkyMTYsImV4cCI6MjA3ODU2NTIxNn0.em0Vqr8Qxyqe9s3rupXZEHBKV4eC1sgLINK2k14dYq4';
    const sb = (window.supabase) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // --- State (in-memory only; no localStorage) ---
    let sightings = []; // [{lat, lng, ts}]

    const heatLayer = L.heatLayer([], { radius: 22, blur: 18, minOpacity: 0.25 }).addTo(map);

    const addBtn = document.getElementById('addBtn');
    const stopBtn = document.getElementById('stopBtn');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');

    let adding = false;

    function render() {
      countEl.textContent = sightings.length;
      const heatPoints = sightings.map(pt => [pt.lat, pt.lng, 1.0]);
      heatLayer.setLatLngs(heatPoints);
    }

    async function syncFromRemote() {
      if(!sb) return;
      setStatus('Loading‚Ä¶');
      const { data, error } = await sb.from('sightings')
        .select('ts,lat,lng')
        .order('ts', { ascending: true })
        .limit(10000);
      if (!error && Array.isArray(data)) {
        sightings = data.map(r => ({ ts: Number(r.ts)||Date.now(), lat: Number(r.lat), lng: Number(r.lng) }));
        render();
        setStatus('');
      } else {
        console.warn('Supabase select error', error);
        setStatus('Failed to load');
      }
    }

    async function postSighting(pt){
      if(!sb) return;
      setStatus('Saving‚Ä¶');
      const { error } = await sb.from('sightings').insert({ ts: pt.ts, lat: pt.lat, lng: pt.lng, ua: navigator.userAgent });
      if (error) {
        console.warn('Supabase insert error', error);
        setStatus('Save failed');
      } else {
        setStatus('');
        // Pull latest after save
        syncFromRemote();
      }
    }

    function setStatus(t){ statusEl.textContent = t || ''; }

    // --- Add mode ---
    addBtn.addEventListener('click', () => { adding = true; addBtn.classList.add('toggled'); });
    stopBtn.addEventListener('click', () => { adding = false; addBtn.classList.remove('toggled'); });

    map.on('click', (e) => {
      if(!adding) return;
      const { lat, lng } = e.latlng;
      const pt = { lat, lng, ts: Date.now() };
      // Optimistic UI: update heat immediately
      sightings.push(pt);
      render();
      // Save to Supabase (no local persistence)
      postSighting(pt);
    });

    // Initial load + periodic refresh (no realtime requirement)
    syncFromRemote();
    setInterval(syncFromRemote, 20000); // refresh every 20s
  </script>
</body>
</html>
